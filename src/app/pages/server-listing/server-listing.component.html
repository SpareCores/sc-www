<div class="w-full bg-primary">
  <div class="content pt-16 pb-16">
    <app-breadcrumbs [segments]="breadcrumbs"></app-breadcrumbs>

    <div class="flex flex-col gap-4 my-8 mx-2 xl:mx-0">
      <div class="flex gap-4 items-center w-full justify-between">
        <h1 class="text-white font-bold text-3xl flex items-center">
          <lucide-icon class="h-8 w-8 mr-2" name="ship-wheel"></lucide-icon>
          {{ title }}
        </h1>
        <button
          class="btn-primary py-2 px-3 flex gap-1 items-center"
          (click)="clipboardURL()"
        >
          Share
          <lucide-icon
            name="{{ clipboardIcon }}"
            size="16"
            class="ml-2"
          ></lucide-icon>
        </button>
      </div>
      <div class="text-white text-xl pr-16">
        {{ description }}
      </div>
    </div>

    <div class="flex gap-8 mx-2 xl:mx-0">
      <div
        class="filter_bar bg-primary"
        [ngClass]="{
          collapsed: isCollapsed,
        }"
      >
        <div
          class="collapser bg-secondary"
          (click)="toggleCollapse()"
          tabindex="0"
          data-ph-capture-attribute-sc-event="server listing toggle sidebar"
        >
          <lucide-icon
            name="chevron-left"
            class="h-6 w-6 text-emerald-400"
          ></lucide-icon>
        </div>

        <app-search-bar
          [query]="query"
          [filterCategories]="filterCategories"
          [searchParameters]="searchParameters"
          [extraParameters]="specialParameters"
          (searchChanged)="searchBarChanged($event)"
        >
        </app-search-bar>
      </div>
      <div
        class="list_holder flex flex-col gap-4"
        [ngClass]="{
          'limited-full': !isCollapsed,
          'w-full': isCollapsed,
        }"
      >
        <div
          class="top_buttons w-[calc(100%-60px)] flex justify-end gap-6 items-center ml-auto"
        >
          <div class="min-w-0">
            <button
              id="benchmark_select_button"
              data-ph-capture-attribute-sc-event="server listing benchmark select"
              class="dropdown_button min-w-0 max-w-full"
              (click)="openModal()"
              type="button"
            >
              @if (!selectedBenchmarkConfig) {
                <div class="px-4 py-3 flex-1 min-w-0">
                  <span class="hidden md:inline truncate block"
                    >Select Benchmark</span
                  >
                  <span class="md:hidden truncate block">Benchmark</span>
                </div>
              }
              @if (selectedBenchmarkConfig) {
                <div class="px-4 py-0 flex flex-col min-w-0">
                  <div class="truncate">
                    {{ selectedBenchmarkConfig.benchmarkTemplate.name }}
                  </div>
                  <div class="text-xs truncate">
                    {{ selectedBenchmarkConfig.config }}
                  </div>
                </div>
              }
              <div
                class="px-4 py-3 w-12 h-full bg-primary justify-center items-center flex rounded-r-lg"
              >
                <lucide-icon
                  name="gauge"
                  class="h-6 w-6 text-emerald-400"
                ></lucide-icon>
              </div>
            </button>
          </div>
          <div>
            <button
              id="column_button"
              data-ph-capture-attribute-sc-event="server listing columns select"
              data-dropdown-toggle="column_options"
              class="dropdown_button"
              type="button"
            >
              <div class="px-4 py-3">Columns</div>
              <div
                class="px-4 py-3 w-12 h-full bg-primary justify-center items-center flex rounded-r-lg"
              >
                <lucide-icon
                  name="chevron-down"
                  class="h-6 w-6 text-emerald-400"
                ></lucide-icon>
              </div>
            </button>
          </div>
        </div>
        <div>
          <div
            class="w-full overflow-x-auto relative"
            style="padding-left: 1px"
          >
            @if (isLoading) {
              <div
                class="absolute top-0 left-0 w-full h-full"
                style="background-color: rgba(0, 0, 0, 0.2)"
              >
                <div class="flex justify-center mt-16 opacity-100">
                  <app-loading-spinner size="lg"></app-loading-spinner>
                </div>
              </div>
            }
            <table class="items_table" id="servers_table">
              <thead>
                <tr>
                  <th class="checkbox_column">
                    <div class="text-white">
                      <lucide-icon class="h-4 w-4" name="scale"></lucide-icon>
                    </div>
                  </th>
                  @for (column of tableColumns; track column.name) {
                    <th
                      [ngClass]="{
                        'cursor-pointer': column.orderField,
                      }"
                      (click)="toggleOrdering(column)"
                    >
                      <div class="flex gap-1 whitespace-nowrap">
                        {{ column.name }}
                        @if (column.info) {
                          <lucide-icon
                            name="info"
                            (mouseenter)="showTooltip($event, column.info)"
                            (mouseleave)="hideTooltip()"
                            class="h-4 w-4 text-gray-200"
                          >
                          </lucide-icon>
                        }
                        @if (getOrderingIcon(column)) {
                          <lucide-icon
                            name="{{ getOrderingIcon(column) }}"
                            class="h-4 w-4 text-white"
                          ></lucide-icon>
                        }
                      </div>
                    </th>
                  }
                  <th></th>
                </tr>
              </thead>
              <tbody>
                @for (
                  item of servers;
                  track item.vendor_id + "_" + item.server_id;
                  let i = $index
                ) {
                  <tr
                    (click)="openServerDetails(item)"
                    data-ph-capture-attribute-sc-event="server listing route to server details"
                    [attr.data-ph-capture-attribute-server-listing-row-vendor]="
                      item.vendor_id
                    "
                    [attr.data-ph-capture-attribute-server-listing-row-index]="
                      i + 1
                    "
                    [attr.data-ph-capture-attribute-server-listing-row-page-size]="
                      limit
                    "
                    class="server_table_data_line"
                  >
                    <td
                      (click)="toggleCompare2($event, item)"
                      class="checkbox_column"
                    >
                      <div class="flex items-center">
                        <input
                          type="checkbox"
                          id="server_compare_checkbox_{{ item.server_id }}"
                          [(ngModel)]="item.selected"
                          (ngModelChange)="toggleCompare($event, item)"
                          (click)="$event.stopPropagation()"
                          class="focus:ring-emerald-400 accent-emerald-400 text-emerald-400 outline-none cursor-pointer"
                        />
                      </div>
                    </td>
                    @for (column of tableColumns; track column.name) {
                      @if (column.type === "name") {
                        <td>
                          <div (click)="$event.stopPropagation()">
                            <a
                              routerLink="/server/{{ item.vendor.vendor_id }}/{{
                                item.api_reference
                              }}"
                              data-ph-capture-attribute-sc-event="server listing route to server details"
                              [attr.data-ph-capture-attribute-server-listing-row-vendor]="
                                item.vendor_id
                              "
                              [attr.data-ph-capture-attribute-server-listing-row-index]="
                                i + 1
                              "
                              [attr.data-ph-capture-attribute-server-listing-row-page-size]="
                                limit
                              "
                            >
                              <div class="text-sm text-white flex gap-1">
                                <span class="whitespace-nowrap"
                                  >{{ item.display_name }}
                                </span>
                                @if (showAPIReference(item)) {
                                  <span class="text-emerald-400">|</span>
                                  <span class="whitespace-nowrap"
                                    >{{ item.api_reference }}
                                  </span>
                                }
                              </div>
                              <div class="text-xs text-white flex gap-1">
                                <span>{{ item.vendor_id }}</span>
                              </div>
                            </a>
                          </div>
                        </td>
                      }
                      @if (column.type === "processor") {
                        <td>
                          <div class="text-sm text-white whitespace-nowrap">
                            {{ item.vcpus }} vCPUs ({{ item.cpu_architecture }})
                          </div>
                          <div class="flex gap-1">
                            @if (item.cpu_cores && item.cpu_speed) {
                              <div class="text-xs text-white flex gap-1">
                                <span class="whitespace-nowrap"
                                  >{{ item.cpu_cores }} cores &#64;
                                  {{ item.cpu_speed }} GHz</span
                                >
                              </div>
                            }
                            @if (
                              item.cpu_allocation &&
                              item.cpu_allocation !== "Dedicated"
                            ) {
                              <div class="text-xs text-white flex gap-1">
                                <span>({{ item.cpu_allocation }})</span>
                              </div>
                            }
                          </div>
                        </td>
                      }
                      @if (column.type === "price") {
                        <td>
                          @if (item[column.key || "price"]) {
                            <div class="text-sm text-white whitespace-nowrap">
                              {{ item[column.key || "price"] }} USD
                            </div>
                          }
                          @if (!item[column.key || "price"]) {
                            <div class="text-sm text-white">-</div>
                          }
                        </td>
                      }
                      @if (column.type === "score") {
                        <td>
                          <div class="text-sm text-white whitespace-nowrap">
                            {{ getScore(item.score) }}
                          </div>
                          @if (item.score_per_price) {
                            <div class="text-xs text-white flex gap-1">
                              <span class="whitespace-nowrap"
                                >{{ getScore(item.score_per_price) }} /
                                USD</span
                              >
                            </div>
                          }
                        </td>
                      }
                      @if (column.type === "benchmark") {
                        <td>
                          <div class="text-sm text-white whitespace-nowrap">
                            {{ getScore(item.selected_benchmark_score) }}
                          </div>
                          @if (item.selected_benchmark_score) {
                            <div class="text-xs text-white flex gap-1">
                              <span class="whitespace-nowrap">{{
                                selectedBenchmarkConfig.short_unit
                              }}</span>
                            </div>
                          }
                        </td>
                      }
                      @if (column.type === "score_per_price") {
                        <td>
                          @if (item.score_per_price) {
                            <span class="whitespace-nowrap"
                              >{{ getScore(item.score_per_price) }} / USD</span
                            >
                          }
                          @if (!item.score_per_price) {
                            <span>-</span>
                          }
                        </td>
                      }
                      @if (column.type === "benchmark_score_per_price") {
                        <td>
                          @if (item.selected_benchmark_score_per_price) {
                            <span class="whitespace-nowrap"
                              >{{
                                getScore(
                                  item.selected_benchmark_score_per_price
                                )
                              }}
                              {{
                                selectedBenchmarkConfig.unit_abbreviation
                              }}</span
                            >
                            <div class="text-xs text-white flex gap-1">
                              <span class="whitespace-nowrap">for $1/hour</span>
                            </div>
                          } @else {
                            <span>-</span>
                          }
                        </td>
                      }
                      @if (column.type === "memory") {
                        <td>
                          <div class="text-sm text-white">
                            {{ getMemory(item) }}
                          </div>
                          @if (item.memory_speed) {
                            <div class="text-xs text-white flex gap-1">
                              @if (!item.memory_generation) {
                                <span class="whitespace-nowrap"
                                  >{{ item.memory_speed }} MHz</span
                                >
                              }
                              @if (item.memory_generation) {
                                <span class="whitespace-nowrap"
                                  >{{ item.memory_speed }} MHz ({{
                                    item.memory_generation
                                  }})</span
                                >
                              }
                            </div>
                          }
                        </td>
                      }
                      @if (column.type === "gpu_memory_min") {
                        <td>
                          {{ getGPUMemory(item, "min") }}
                        </td>
                      }
                      @if (column.type === "gpu_memory_total") {
                        <td>
                          {{ getGPUMemory(item, "total") }}
                        </td>
                      }
                      @if (column.type === "storage") {
                        <td>
                          <div class="text-sm text-white">
                            {{ getStorage(item) }}
                          </div>
                          @if (item.storage_type) {
                            <div class="text-xs text-white">
                              <span>{{ item.storage_type }}</span>
                            </div>
                          }
                        </td>
                      }
                      @if (column.type === "gpu") {
                        <td>
                          <div class="text-sm text-white">
                            {{ item.gpu_count }}
                          </div>
                          @if (item.gpu_model) {
                            <div class="text-xs text-white flex gap-1">
                              <span>{{ item.gpu_model }}</span>
                            </div>
                          }
                        </td>
                      }
                      @if (column.type === "cpu_model") {
                        <td>
                          @if (item.cpu_model) {
                            <div class="text-sm text-white flex gap-1">
                              <span>{{ item.cpu_model }}</span>
                            </div>
                          }
                          <div class="text-xs text-white">
                            @if (item.cpu_manufacturer) {
                              <span>{{ item.cpu_manufacturer }} </span>
                            }
                            @if (item.cpu_family) {
                              <span>{{ item.cpu_family }} </span>
                            }
                          </div>
                        </td>
                      }
                      @if (column.type === "gpu_model") {
                        <td>
                          @if (item.gpu_model) {
                            <div class="text-sm text-white flex gap-1">
                              <span>{{ item.gpu_model }}</span>
                            </div>
                          }
                          <div class="text-xs text-white">
                            @if (item.gpu_manufacturer) {
                              <span>{{ item.gpu_manufacturer }} </span>
                            }
                            @if (item.gpu_family) {
                              <span>{{ item.gpu_family }} </span>
                            }
                          </div>
                        </td>
                      }
                      @if (column.type === "text" && column.key) {
                        <td>
                          {{ getField(item, column.key) }}
                        </td>
                      }
                      @if (column.type === "vendor") {
                        <td>
                          @if (item.vendor.logo) {
                            <div class="w-9 h-9 px-1 py-1 bg-white rounded-lg">
                              <img
                                [src]="item.vendor.logo"
                                alt="{{ item.vendor.name }} logo"
                              />
                            </div>
                          }
                          @if (!item.vendor.logo) {
                            <div class="text-white text-sm">
                              {{ item.vendor.name }}
                            </div>
                          }
                        </td>
                      }
                    }
                    <td>
                      <div (click)="$event.stopPropagation()">
                        <a
                          routerLink="/server/{{ item.vendor.vendor_id }}/{{
                            item.api_reference
                          }}"
                          data-ph-capture-attribute-sc-event="server listing route to server details"
                          [attr.data-ph-capture-attribute-server-listing-row-vendor]="
                            item.vendor_id
                          "
                          [attr.data-ph-capture-attribute-server-listing-row-index]="
                            i + 1
                          "
                          [attr.data-ph-capture-attribute-server-listing-row-page-size]="
                            limit
                          "
                        >
                          <lucide-icon
                            name="chevron-right"
                            class="h-6 w-6 text-emerald-400"
                          ></lucide-icon>
                        </a>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          <div>
            <div class="flex justify-between mt-4">
              <div>
                <button
                  id="pagesize_button"
                  data-ph-capture-attribute-sc-event="server listing page size select"
                  class="dropdown_button"
                  type="button"
                >
                  <div class="px-4 py-2">
                    {{ limit }}
                  </div>
                  <div
                    class="px-2 py-2 w-12 h-full bg-primary justify-center items-center flex rounded-r-lg"
                  >
                    <lucide-icon
                      name="chevron-down"
                      class="h-6 w-6 text-emerald-400"
                    ></lucide-icon>
                  </div>
                </button>
                <span class="text-white"> items per page</span>
              </div>
              <div>
                <app-pagination
                  baseURL="/servers"
                  [currentPage]="page"
                  [totalPages]="totalPages"
                  [baseQueryParams]="getQueryObjectBase()"
                >
                </app-pagination>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@if (compareCount() >= 2) {
  <div class="fixed_buttons">
    <div class="flex gap-4">
      <button
        class="flex justify-center bg-red-400 text-white py-2 px-4 rounded-lg font-bold hover:bg-red-500"
        data-ph-capture-attribute-sc-event="server listing compare"
        data-ph-capture-attribute-server-listing-compare-action="clear"
        (click)="clearCompare()"
      >
        Clear
      </button>
      <button
        class="flex justify-center bg-emerald-400 text-white py-2 px-4 rounded-lg font-bold hover:bg-emerald-500"
        data-ph-capture-attribute-sc-event="server listing compare"
        data-ph-capture-attribute-server-listing-compare-action="open"
        (click)="openCompare()"
      >
        Compare ({{ compareCount() }})
      </button>
    </div>
  </div>
}

<div
  id="pagesize_options"
  class="z-10 hidden bg-secondary rounded-lg shadow w-44 border border-emerald-400 border-solid"
>
  <ul
    class="py-2 px-1 text-sm text-gray-700"
    aria-labelledby="dropdownDefaultButton"
  >
    @for (pageLimit of pageLimits; track $index) {
      <li
        class="flex py-1 px-2 gap-2 items-center cursor-pointer hover:bg-emerald-500 rounded-sm"
        (click)="selectPageSize(pageLimit)"
        (keydown.enter)="selectPageSize(pageLimit)"
        (keydown.space)="selectPageSize(pageLimit); $event.preventDefault()"
        role="option"
        [attr.aria-selected]="pageLimit === limit"
        tabindex="0"
      >
        <div class="text-white text-sm">{{ pageLimit }}</div>
      </li>
    }
  </ul>
</div>

<div
  id="column_options"
  class="z-10 hidden bg-secondary rounded-lg shadow w-52 border border-emerald-400 border-solid"
>
  <ul
    class="py-2 px-3 text-sm text-gray-700"
    aria-labelledby="dropdownDefaultButton"
  >
    @for (column of possibleColumns; track column.name) {
      <li class="flex py-1 gap-2 items-center">
        <input
          type="checkbox"
          [(ngModel)]="column.show"
          (ngModelChange)="refreshColumns()"
          class="focus:ring-emerald-400 accent-emerald-400 text-emerald-400 outline-none cursor-pointer"
        />
        <div class="text-white text-sm">{{ column.name }}</div>
      </li>
    }
  </ul>
</div>

<div
  id="tooltipDefault"
  #tooltipDefault
  style="opacity: 0"
  class="absolute z-10 inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-secondary border border-solid border-emerald-400 rounded-lg"
>
  {{ tooltipContent }}
</div>

<!-- Large Modal -->
<div
  id="benchmark-type-modal"
  tabindex="-1"
  class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-fit min-h-full flex items-center"
>
  <div class="relative w-full max-w-xl">
    <div
      class="relative bg-secondary rounded-lg shadow border border-solid border-emerald-400 flex flex-col max-h-[calc(100vh-2rem)]"
    >
      <div
        class="flex items-center justify-between p-4 md:p-5 border-b rounded-t"
      >
        <h3 class="text-xl font-medium text-white dark:text-white">
          {{ modalText }}
        </h3>
        <button
          type="button"
          data-ph-capture-attribute-sc-event="server listing search prompt close"
          data-ph-capture-attribute-server-listing-search-prompt-action="close"
          class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center"
          (click)="closeModal()"
        >
          <svg
            class="w-3 h-3"
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 14 14"
          >
            <path
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"
            />
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      <div class="p-4 md:p-5 space-y-4 flex flex-col flex-1 min-h-0">
        @if (!tempSelectedBenchmarkCategory) {
          <div class="flex gap-2 flex-wrap justify-center">
            <button
              (click)="selectBenchmarkCategory('All')"
              type="button"
              class="dropdown_group_button"
            >
              All
            </button>
            @for (category of benchmarkCategories; track $index) {
              <button
                (click)="selectBenchmarkCategory(category)"
                type="button"
                class="dropdown_group_button"
              >
                {{ category }}
              </button>
            }
          </div>
        }
        @if (tempSelectedBenchmarkCategory) {
          <div class="flex flex-col gap-2 flex-1 min-h-0">
            <div class="relative mx-2">
              <div
                class="border border-emerald-400 absolute inset-x-0 start-0 flex items-center pointer-events-none z-20 px-3 bg-secondary rounded-l-lg w-12 h-full"
              >
                <lucide-icon
                  class="text-emerald-400 w-5 h-5"
                  name="search"
                ></lucide-icon>
              </div>
              <input
                placeholder="Filter"
                type="text"
                class="dropdown_input"
                [(ngModel)]="modalFilterTerm"
                (ngModelChange)="updateFilterTerm()"
              />
            </div>
            <div
              class="flex flex-col overflow-y-auto custom-scrollbar button_list_holder flex-1"
            >
              @for (
                benchmarkConfig of tempfilteredBenchmarkConfigs;
                track benchmarkConfig.benchmarkTemplate.benchmark_id
              ) {
                <button
                  (click)="selectBenchmarkConfig(benchmarkConfig)"
                  type="button"
                  [ngClass]="{
                    active: benchmarkConfig === selectedBenchmarkConfig,
                  }"
                  class="button_list_item"
                >
                  <div>
                    {{ benchmarkConfig.benchmarkTemplate.name }}
                  </div>
                  <div class="text-xs">
                    {{ benchmarkConfig.config }}
                  </div>
                </button>
              }
            </div>
          </div>
        }
      </div>
      @if (tempSelectedBenchmarkCategory) {
        <div
          class="flex justify-center p-4 md:p-5 space-x-3 border-t border-gray-200 rounded-b"
        >
          <button
            class="flex justify-center border border-emerald-400 text-emerald-400 py-2 px-4 rounded-lg hover:bg-emerald-400 hover:text-white items-center"
            (click)="selectBenchmarkCategory(null)"
          >
            <lucide-icon name="chevron-left" class="h-5 w-5"></lucide-icon>
            Back to benchmark categories
          </button>
        </div>
      }
    </div>
  </div>
</div>
